<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Compress Video</title>
        <style>
            body {
                display: flex;
                height: 100vh;
                justify-content: center;
                align-items: center;
                background-color: #f5f5f5;
                margin: 0;
            }
            #form-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
                background: white;
                padding: 2rem;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                width: 320px;
            }
            input,
            button {
                padding: 0.5rem;
                font-size: 1rem;
            }
            /* popup notification */
            #notification {
                display: none;
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #333;
                color: #fff;
                padding: 1rem 1.5rem;
                border-radius: 4px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                font-size: 0.9rem;
                z-index: 1000;
            }
            #downloadBtn {
                display: none;
                text-decoration: none;
                text-align: center;
                background: #28a745;
                color: white;
                padding: 0.5rem;
                border-radius: 4px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div id="form-container">
            <h1 style="text-align: center">–°–∂–∞—Ç–∏–µ –≤–∏–¥–µ–æ</h1>
            <input
                type="url"
                id="video_url"
                placeholder="–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ"
                required
            />
            <button id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <a id="downloadBtn">–°–∫–∞—á–∞—Ç—å</a>
        </div>

        <div id="notification"></div>

        <script>
            const submitBtn = document.getElementById("submitBtn");
            const downloadBtn = document.getElementById("downloadBtn");
            const notification = document.getElementById("notification");
            let pollHandle;
            let requestId;

            function showNotification(msg) {
                notification.textContent = msg;
                notification.style.display = "block";
                setTimeout(() => {
                    notification.style.display = "none";
                }, 4000);
            }

            async function checkStatus() {
                if (!requestId) return;
                try {
                    const res = await fetch(
                        `v1/videos/status/?request_id=${requestId}`,
                    );
                    if (res.status === 200) {
                        clearInterval(pollHandle);
                        submitBtn.disabled = false;
                        showNotification("‚úÖ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω!");
                        downloadBtn.href = `/output/${requestId}`;
                        downloadBtn.style.display = "block";
                    } else if (res.status === 204) {
                        showNotification("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶");
                    } else if (res.status === 202) {
                        showNotification("–í –æ—á–µ—Ä–µ–¥–∏‚Ä¶");
                    } else {
                        clearInterval(pollHandle);
                        submitBtn.disabled = false;
                        const text = await res.text();
                        showNotification(`–û—à–∏–±–∫–∞: ${text}`);
                    }
                } catch (err) {
                    clearInterval(pollHandle);
                    showNotification(
                        "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                    );
                    console.error(err);
                }
            }

            submitBtn.addEventListener("click", async () => {
                const url = document.getElementById("video_url").value.trim();
                if (!url) return;

                // disable button to prevent double‚Äêsubmit
                submitBtn.disabled = true;
                downloadBtn.style.display = "none";

                try {
                    const res = await fetch("v1/videos/compress/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ video_url: url }),
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        showNotification(`–û—à–∏–±–∫–∞: ${err.detail[0].msg}`);
                        submitBtn.disabled = false;
                        return;
                    }

                    requestId = await res.text();
                    showNotification("üì¨ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å");
                    pollHandle = setInterval(checkStatus, 5000);
                } catch (err) {
                    showNotification(
                        "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                    );
                    console.error(err);
                    submitBtn.disabled = false;
                }
            });
        </script>
    </body>
</html>
